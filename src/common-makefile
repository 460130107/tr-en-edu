TOK = $(shell find txt -type f | perl -pe 's/txt/tok/g')
ALN = $(shell find tok -type f)

# English-Tools
TOKENIZER_EN=../../src/moses-scripts/tokenizer.perl -l en
SENTENCESP_EN=../../src/moses-scripts/split-sentences.perl -l en
ALIGN_EN=""
# Turkish-Tools
SENTENCESP_TR=../../src/moses-scripts/split-sentences.perl -l tr
TOKENIZER_TR=../../src/moses-scripts/tokenizer.perl -l tr
# Aligner
ALIGN=../../src/hunalign-1.1/hunalign -text -bisent -realign -utf ../..//src/hunalign-1.1/data/en-tr.dic
ALIGNTHR=0

#Remove all repetition
RCOUNT=../src/rcount
MULTTHR=10
REMMULT=../src/remmult.pl

#all: ${TOK}
#	echo ${TOK}

tok: ${TOK}
#	echo ${TOK}

%.txt.tgz: %.html.tgz
	tar xzf $<
	mkdir -p $*/txt 
	cd $*/html;make
	tar czf $@ $*/txt
	rm -rf $*

%.tok.tgz: %.txt.tgz
	tar xzf $< 
	cp Makefile $*
	cd $*;make tok
	tar czf $@ $*/tok
	rm -rf $*

tok/%.tok.en: txt/%.txt.en
	mkdir -p tok
	cat $< | ${TOKENIZER_EN} 2>$*.tok.en.err | ${SENTENCESP_EN} > $@ 2>$*.stc.en.err
	-rm *.en.err

tok/%.tok.tr: txt/%.txt.tr
	mkdir -p tok
	cat $< | ${TOKENIZER_TR} 2>$*.tok.en.err | ${SENTENCESP_TR} > $@ 2>$*.stc.tr.err
	-rm *.tr.err

%.aln.tgz: %.tok.tgz
	tar xzf $<
	cp Makefile $*
	cd $*;make batch
	tar czf $@ $*/aln
	rm -rf $*

batch:
	mkdir -p aln	
	ls tok | perl -lane 'my $$t = join("\n",@F);print "$$t";' > aln/batch.tmp
	cat aln/batch.tmp | perl -lane 'if($$_ =~ /(.*?)\.tok.en$$/){ print "tok/$$1.tok.tr\ttok/$$1.tok.en\taln/$$1.aln";}' > aln/batch
	rm aln/batch.tmp
	-${ALIGN} -batch aln/batch >align.out 2>align.err
	-rm aling.out align.err aln/batch

# Print the concatenated alignment file for each language separately
# Remove <P> and the alignmens with <ALIGNTHR scores and empty lines.
# Multiple lines seen more than THR are only printed THR times
anadolu.aln: anadolu.aln.tgz
	tar xzf $<
	cat anadolu/aln/*.aln | perl -lane 'print if ($$_ !~ /<P>/ && $$F[-1] > 0.8 && $$_ !~ /^\t\t\d+/)' > anadolu.aln
	cat anadolu.aln | cut -f1 >anadolu.tmp1
	cat anadolu.aln | cut -f2 >anadolu.tmp2
	paste anadolu.tmp1 anadolu.tmp2 | ${RCOUNT} | ${REMMULT} 10 |cut -f1 | gzip > anadolu.tr.gz
	paste anadolu.tmp1 anadolu.tmp2 | ${RCOUNT} | ${REMMULT} 10 |cut -f2 | gzip > anadolu.en.gz
	rm -rf anadolu anodulu.tmp1 anadolu.tmp2 

marmara.aln: marmara.aln.tgz
	tar xzf $<
	cat marmara/aln/*.aln | perl -lane 'print if ($$_ !~ /<P>/ && $$F[-1] > 0.8 && $$_ !~ /^\t\t\d+/)' > marmara.aln
	cat marmara.aln | cut -f1 >marmara.tmp1
	cat marmara.aln | cut -f2 >marmara.tmp2
	paste marmara.tmp1 marmara.tmp2 | ${RCOUNT} | ${REMMULT} 10 |cut -f1 | gzip > marmara.tr.gz
	paste marmara.tmp1 marmara.tmp2 | ${RCOUNT} | ${REMMULT} 10 |cut -f2 | gzip > marmara.en.gz
	rm -rf marmara marmara.tmp1 marmara.tmp2

%.aln: %.aln.tgz
	tar xzf $<
	cat $*/aln/*.aln | perl -lane 'print if ($$_ !~ /<P>/ && $$F[-1] > ${ALIGNTHR} && $$_ !~ /^\t\t\d+/)' > $*.aln
	cat $*.aln | cut -f1 >$*.tmp1
	cat $*.aln | cut -f2 >$*.tmp2
	paste $*.tmp1 $*.tmp2 | ${RCOUNT} | ${REMMULT} ${MULTTHR} |cut -f1 | gzip > $@.tr.gz
	paste $*.tmp1 $*.tmp2 | ${RCOUNT} | ${REMMULT} ${MULTTHR} |cut -f2 | gzip > $@.en.gz
	rm -rf $* $*.tmp1 $*.tmp2 

### MAKEFILE MISC:
.PRECIOUS: %.tok.tgz %.txt.tgz %.aln.tgz %.html.tgz
